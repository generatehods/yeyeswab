<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>YEYESWAB — Endocrine System DEX</title>

<style>
    body {
        background:#04080f;
        color:white;
        font-family:Arial;
        margin:0;
        padding:20px;
        text-align:center;
    }
    .card {
        background:#0c1424;
        padding:20px;
        border-radius:15px;
        max-width:380px;
        margin:0 auto;
        box-shadow:0 0 20px #000;
    }
    input, select {
        width:100%;
        padding:12px;
        border-radius:8px;
        border:none;
        margin-top:8px;
        font-size:16px;
    }
    button {
        width:100%;
        padding:14px;
        border:none;
        background:#23a6f2;
        border-radius:10px;
        color:white;
        margin-top:15px;
        font-size:18px;
    }
</style>
</head>
<body>

<h2>YEYESWAB — Simple Solana Swap (Endocrine System)</h2>

<div class="card">
    <button id="connectBtn">Connect Wallet</button>

    <h3 style="margin-top:25px;">Swap</h3>

    <input id="amountIn" type="number" placeholder="Amount In">

    <select id="tokenIn">
        <option value="">Token In</option>
    </select>

    <select id="tokenOut" style="margin-top:10px;">
        <option value="">Token Out</option>
    </select>

    <button id="swapBtn">Swap</button>
</div>

<script type="module">
import {
    Connection,
    PublicKey,
    LAMPORTS_PER_SOL,
    Transaction
} from "https://esm.sh/@solana/web3.js";

// --- TOKEN DEFINITIONS ---
// Pastikan desimal di sini benar! USDC/USDT umumnya 6. SOL adalah 9.
const ALL_TOKENS = [
    { name: "SOL", mint: "So11111111111111111111111111111111111111112", decimals: 9 },
    { name: "USDC", mint: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGHZad949EoE", decimals: 6 },
    { name: "USDT", mint: "Es9vMFrzaCERzYLztsF6D2PfYZ7R6puj949iEzb7gA3y", decimals: 6 },
    { name: "JUP", mint: "JUPyiwrYJFskUPiHa7hkeR8bocQokkBZexzL8CyhrUD", decimals: 6 },
    { name: "WEN", mint: "5h7E2B5eB5tT4q1M12zS8f4fK6M22P7T4v8G4g6X6Q2", decimals: 5 },
    { name: "PYTH", mint: "HZ1xYq262h8T49oE4u8C1m7J4f7E7z4f7z4f7z4f7z4f", decimals: 6 }, 
    { name: "ENDC", mint: "[REPLACE WITH YOUR ENDOCRINE SYSTEM MINT ADDRESS]", decimals: 6 }, // Your Token
    { name: "FROG", mint: "[REPLACE WITH FROG MINT ADDRESS]", decimals: 6 },
];

const JUP_API = "https://quote-api.jup.ag/v6/quote";
const connection = new Connection("https://api.mainnet-beta.solana.com");

let wallet = null;

// --- UTILITY FUNCTIONS ---

// Function to fetch wallet balances
async function getWalletBalances(publicKey) {
    const balances = {};
    const walletPublicKey = new PublicKey(publicKey);

    // 1. Get SOL Balance
    const solBalanceLamports = await connection.getBalance(walletPublicKey);
    balances["So11111111111111111111111111111111111111112"] = solBalanceLamports / LAMPORTS_PER_SOL;

    // 2. Get SPL Token Balances
    for (const token of ALL_TOKENS.filter(t => t.mint !== "So11111111111111111111111111111111111111112")) {
        try {
            const tokenAccounts = await connection.getTokenAccountsByOwner(
                walletPublicKey,
                { mint: new PublicKey(token.mint) }
            );

            if (tokenAccounts.value.length > 0) {
                const accountInfo = await connection.getTokenAccountBalance(tokenAccounts.value[0].pubkey);
                // Use uiAmount and format to 4 decimal places
                balances[token.mint] = parseFloat(accountInfo.value.uiAmount).toFixed(4); 
            } else {
                balances[token.mint] = 0;
            }
        } catch (error) {
            console.error(`Failed to get balance for ${token.name}:`, error);
            balances[token.mint] = 0;
        }
    }
    return balances;
}

// Function to update dropdowns with balances
async function updateTokenOptions(balances) {
    const tokenInSelect = document.getElementById("tokenIn");
    const tokenOutSelect = document.getElementById("tokenOut");

    tokenInSelect.innerHTML = '';
    tokenOutSelect.innerHTML = '';

    // Add default "Select Token" options
    tokenInSelect.innerHTML = '<option value="" disabled selected>Select Token In (with Balance)</option>';
    tokenOutSelect.innerHTML = '<option value="" disabled selected>Select Token Out</option>';

    ALL_TOKENS.forEach(token => {
        const balance = balances[token.mint] || 0;
        
        // Token In displays balance
        const optionIn = document.createElement('option');
        optionIn.value = token.mint;
        // Ensure SOL balance is also formatted correctly
        const formattedBalance = token.name === "SOL" ? parseFloat(balance).toFixed(4) : parseFloat(balance).toLocaleString(undefined, { maximumFractionDigits: 4 });

        optionIn.textContent = `${token.name} (${formattedBalance})`;
        tokenInSelect.appendChild(optionIn);

        // Token Out does not display balance
        const optionOut = document.createElement('option');
        optionOut.value = token.mint;
        optionOut.textContent = token.name; 
        tokenOutSelect.appendChild(optionOut);
    });
}

// --- Connect Wallet ---
document.getElementById("connectBtn").onclick = async () => {
    if (window.phantom?.solana) {
        try {
            const resp = await window.phantom.solana.connect();
            wallet = resp.publicKey.toString();
            document.getElementById("connectBtn").innerText = "Connected: " + wallet.substring(0,6) + "...";
            
            // Get and display balances
            const balances = await getWalletBalances(wallet);
            updateTokenOptions(balances);

        } catch (err) {
            console.error("Connection failed:", err);
            alert("Wallet Connection Failed!");
        }
    } else {
        alert("Please Install Phantom Wallet!");
    }
};


// --- Swap ---
document.getElementById("swapBtn").onclick = async () => {
    if (!wallet) return alert("Please connect your wallet first.");

    const amount = document.getElementById("amountIn").value;
    const inputMint = document.getElementById("tokenIn").value;
    const outputMint = document.getElementById("tokenOut").value;

    if (!amount || parseFloat(amount) <= 0) return alert("Please enter a valid amount.");
    if (!inputMint || !outputMint) return alert("Please select both input and output tokens.");

    // --- CRITICAL FIX: Calculate amountInLamports using correct decimals ---
    const inputTokenInfo = ALL_TOKENS.find(t => t.mint === inputMint);
    if (!inputTokenInfo) return alert("Selected input token is not defined in the script.");

    const amountMultiplier = 10 ** inputTokenInfo.decimals; 
    const amountInLamports = Math.floor(parseFloat(amount) * amountMultiplier).toString();


    // --- GET QUOTE ---
    try {
        const quoteResponse = await fetch(`${JUP_API}?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amountInLamports}&slippageBps=100`);
        const quote = await quoteResponse.json();

        if (quote.error) {
            return alert(`Swap Quote Failed: ${quote.error}. Check liquidity or amount.`);
        }
        
        // Add referral fee (0.3% = 30 bps)
        quote.feeBps = 30;
        quote.feeAccount = "FSqRLFnykDnCZ6mQdnn4GPPwNz6NEFYU7sHKmrrw1X5b";  // Your Fee Wallet Address

        // --- GET SWAP TRANSACTION FROM JUPITER ---
        const swapTxResponse = await fetch("https://quote-api.jup.ag/v6/swap-instructions", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                quoteResponse: quote,
                userPublicKey: wallet
            })
        });
        const swapTx = await swapTxResponse.json();

        if (swapTx.error || !swapTx.swapTransaction) {
            return alert(`Transaction Generation Failed: ${swapTx.error || "No swap transaction provided."}`);
        }
        
        // --- EXECUTE TRANSACTION ---
        const tx = Transaction.from(Buffer.from(swapTx.swapTransaction, "base64"));
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

        const signed = await window.phantom.solana.signTransaction(tx);
        const txid = await connection.sendRawTransaction(signed.serialize());
        
        alert("Swap Success!\nTX: " + txid);
        
        // Optional: Reload balance after successful swap
        const balances = await getWalletBalances(wallet);
        updateTokenOptions(balances);
        
    } catch (e) {
        alert("Transaction Execution Failed: " + e.message);
        console.error("Execution Error:", e);
    }
};
</script>
</body>
</html>
